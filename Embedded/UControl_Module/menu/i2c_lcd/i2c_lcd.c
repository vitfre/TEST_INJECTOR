/*
 * i2c_lcd.c
 *
 * Created: 28.07.2015 18:49:49
 *  Author: vmk
 */ 

#include "i2c_lcd.h"

//****************************************************************************************
void PCF8574_Write(unsigned char data)
{
	i2c_start();              //         |-[S]-|  ;Start Condition
	i2c_write(PCF8574_ADDR | I2C_WRITE);    //         |---Slave address (PCF8574)--[A2=0,A1=0,A0=0]---|   +    |-R/W-|
	i2c_acknowledge();        //         |-[A]-|  ;Active LOW
	i2c_write(data);          //         |-------------------data to port-----------------------|
	i2c_acknowledge();        //         |-[A]-|  ;Active LOW
	i2c_stop();               //         |-[P]-|  ;Stop Condition
};
//****************************************************************************************
unsigned char PCF8574_Read(void)
{
	unsigned char ibuff;
	i2c_start();
	i2c_write(PCF8574_ADDR | I2C_READ);
	i2c_acknowledge();
	ibuff=i2c_read();
	i2c_acknowledge();
	i2c_stop();
	return(ibuff);
};
//***************************************************************************************
//Procedure sending LCD byte
//Input: Byte, Kommand/Symbol data
//***************************************************************************************
void send_i2c_lcd_byte(unsigned char lcd_data, unsigned char rs_status ) //bool lcd_command,
{
	//lcd_data=0x08;
	//---------------------------------------------------------------------------------------
	rs_status=rs_status*2;
	PCF8574_Write(rs_status|E_L|((lcd_data<<1)&0xE0)|((lcd_data>>3)&0x10));
	_delay_us(10);
	PCF8574_Write(rs_status|E_H|((lcd_data<<1)&0xE0)|((lcd_data>>3)&0x10));
	_delay_us(10);
	PCF8574_Write(rs_status|E_L|((lcd_data<<1)&0xE0)|((lcd_data>>3)&0x10));
	_delay_us(10);
	PCF8574_Write(rs_status|E_L|((lcd_data<<5)&0xE0)|((lcd_data<<1)&0x10));
	_delay_us(10);
	PCF8574_Write(rs_status|E_H|((lcd_data<<5)&0xE0)|((lcd_data<<1)&0x10));
	_delay_us(10);
	PCF8574_Write(rs_status|E_L|((lcd_data<<5)&0xE0)|((lcd_data<<1)&0x10));
	_delay_us(50);
	//---------------------------------------------------------------------------------------

	
	
	
	
};
/**************************************************************************
*   Function name : i2c_lcd_init
*   Returns :       ініціалізація lcd
*   Parameters :
*   Purpose :       настроюємо i2c_lcd
****************************************************************************/
void i2c_lcd_init(void)
{
	//---------------------------------------------------------------------------------------
	//init i2c
	//---------------------------------------------------------------------------------------
	i2c_init();
	//---------------------------------------------------------------------------------------
	PCF8574_Write(0x00);//E = 0 RS= 0 R/W = 0
	_delay_ms(1);
	//---------------------------------------------------------------------------------------
	//Function Set 3 ????? ?????? D4-D7 ????????????? bus
	PCF8574_Write(0x60);      //1    0x20 + 0x03
	_delay_ms(1);
	PCF8574_Write(0x40);
	_delay_ms(1);
	PCF8574_Write(E_H|0x40);     //2
	_delay_ms(1);
	PCF8574_Write(E_L|0x40);
	_delay_ms(1);
	//---------------------------------------------------------------------------------------
	send_i2c_lcd_byte(0x28,lcd_kom);			//2 lines, 5*8 pixels, 8bit data
	send_i2c_lcd_byte(0x0C,lcd_kom);			//screen enable,
	send_i2c_lcd_byte(0x06,lcd_kom);			//auto shift left enable
	send_i2c_lcd_byte(0x01,lcd_kom);			//0x01 clear screen
	//---------------------------------------------------------------------------------------
	_delay_ms(20);
	//---------------------------------------------------------------------------------------
};






//***************************************************************************************
//Procedure sending LCD symbol
//Input: Symbol
//***************************************************************************************
void send_i2c_lcd_symbol(unsigned char temp_symbol)
{
	//---------------------------------------------------------------------------------------
	send_i2c_lcd_byte(temp_symbol,lcd_sym);
	//---------------------------------------------------------------------------------------
};
//***************************************************************************************
//Procedure setting LCD position
//Input: Line(1,2), Position(1..16)
//***************************************************************************************
void set_i2c_lcd_position(unsigned char temp_line, unsigned char temp_pos)
{
	//---------------------------------------------------------------------------------------
	switch (temp_line)
	{
		//---------------------------------------------------------------------------------------
		case 0x01 :
			temp_line=0x80+temp_pos-1;
		break;
		case 0x02 :
			temp_line=0xC0+temp_pos-1;
		break;
		case 0x03 :
			temp_line=0x94+temp_pos-1;
		break;
		case 0x04 :
			temp_line=0xd4+temp_pos-1;
		break;
		default :;
		//---------------------------------------------------------------------------------------
	};   //switch (temp_line)
	//---------------------------------------------------------------------------------------
	send_i2c_lcd_byte(temp_line,lcd_kom);
	//---------------------------------------------------------------------------------------
};
//***************************************************************************************
//Procedure send symbol string to LCD
//Input: Symbol string
//***************************************************************************************
void send_i2c_lcd_string(const char *temp_string)
{
	//---------------------------------------------------------------------------------------
	unsigned char i=0;
	while(temp_string[i]!=0)
	{
		//---------------------------------------------------------------------------------------
		send_i2c_lcd_byte(temp_string[i],lcd_sym);
		i++;
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
 };
//***************************************************************************************
//Procedure send symbol string to LCD from FLASH
//Input: Symbol string
//***************************************************************************************
void send_i2c_lcd_string_P(const char *string)
{
	//---------------------------------------------------------------------------------------
	while (pgm_read_byte(string)!='\0')
	{
		//---------------------------------------------------------------------------------------
		send_i2c_lcd_byte(pgm_read_byte(string),lcd_sym);
		string++;
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
 };
//***************************************************************************************
//Отправить строку на индикатор  16 символов
//задаются все символы, можно в кодах в виде ('A',0x55)
//***************************************************************************************
void send_i2c_lcd_code_string(char s1,char s2,char s3,char s4,char s5,char s6,char s7,char s8,char s9,char s10,char s11,char s12,char s13,char s14,char s15,char s16)
{
	//---------------------------------------------------------------------------------------
	send_i2c_lcd_byte(s1,lcd_sym);
	send_i2c_lcd_byte(s2,lcd_sym);
	send_i2c_lcd_byte(s3,lcd_sym);
	send_i2c_lcd_byte(s4,lcd_sym);  
	send_i2c_lcd_byte(s5,lcd_sym);
	send_i2c_lcd_byte(s6,lcd_sym);
	send_i2c_lcd_byte(s7,lcd_sym);
	send_i2c_lcd_byte(s8,lcd_sym);
	send_i2c_lcd_byte(s9,lcd_sym);
	send_i2c_lcd_byte(s10,lcd_sym);
	send_i2c_lcd_byte(s11,lcd_sym);
	send_i2c_lcd_byte(s12,lcd_sym);
	send_i2c_lcd_byte(s13,lcd_sym);
	send_i2c_lcd_byte(s14,lcd_sym);
	send_i2c_lcd_byte(s15,lcd_sym);
	send_i2c_lcd_byte(s16,lcd_sym); 
	//---------------------------------------------------------------------------------------
 };
//***************************************************************************************
//Procedure clearing LCD
//***************************************************************************************
void clear_i2c_lcd(void)
{
	//---------------------------------------------------------------------------------------
	send_i2c_lcd_byte(0x01,lcd_kom);
	_delay_ms(10);
	//---------------------------------------------------------------------------------------
};
//***************************************************************************************
//Procedure detecting symbol
//Input: Digit,
//Output: Symbol
//***************************************************************************************
unsigned char detect_i2c_symbol(unsigned char temp_det_sym)
{
	//---------------------------------------------------------------------------------------
	switch(temp_det_sym)
	{
		//---------------------------------------------------------------------------------------
		case 0:{return '0';}break;
		case 1:{return '1';}break;
		case 2:{return '2';}break;	
		case 3:{return '3';}break;
		case 4:{return '4';}break;
		case 5:{return '5';}break;
		case 6:{return '6';}break;	
		case 7:{return '7';}break;
		case 8:{return '8';}break;
		case 9:{return '9';}break;
		default:return '0';
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
};
//***************************************************************************************
//Вывести на индикатор 1 цифру
//***************************************************************************************
void detect_i2c_shortt_string(unsigned char temp_volt)
{
	//---------------------------------------------------------------------------------------
	unsigned char det_string;
	//---------------------------------------------------------------------------------------
	det_string=detect_i2c_symbol(temp_volt);
	send_i2c_lcd_symbol(det_string);
	//---------------------------------------------------------------------------------------
};
//***************************************************************************************
//Вывести на индикатор короткую строку из 2-х цифр
//***************************************************************************************
void detect_i2c_short_string(unsigned char temp_volt)
{
	//---------------------------------------------------------------------------------------
	unsigned char det_string[2]={0,0};
	//---------------------------------------------------------------------------------------
	for (unsigned char j=0;j<=1;j++)
	{
		//---------------------------------------------------------------------------------------
		det_string[j]=detect_i2c_symbol(temp_volt%10);
		temp_volt=temp_volt/10;
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	for (unsigned char j=0;j<=1;j++)
	{
		//---------------------------------------------------------------------------------------
		send_i2c_lcd_symbol(det_string[1-j]);
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
};
//***************************************************************************************
//Вывести на индикатор короткую строку из 3-х цифр
//***************************************************************************************
void detect_i2c_short_3_string(unsigned int temp_volt)
{
	//---------------------------------------------------------------------------------------
	unsigned char det_string[3]={0,0,0};
	//---------------------------------------------------------------------------------------
	for (unsigned char j=0;j<=2;j++)
	{
		//---------------------------------------------------------------------------------------
		det_string[j]=detect_i2c_symbol(temp_volt%10);
		temp_volt=temp_volt/10;
	};
	//---------------------------------------------------------------------------------------
	for (unsigned char j=0;j<=2;j++)
	{
		//---------------------------------------------------------------------------------------
		send_i2c_lcd_symbol(det_string[2-j]);
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
};
//***************************************************************************************
//Вывести на индикатор короткую строку из 4-х цифр
//***************************************************************************************
void detect_i2c_string(unsigned int temp_volt)
{
	//---------------------------------------------------------------------------------------
	unsigned char det_string[4]={0,0,0,0};
	//---------------------------------------------------------------------------------------
	for (unsigned char j=0;j<=3;j++)
	{
		//---------------------------------------------------------------------------------------
		det_string[j]=detect_i2c_symbol(temp_volt%10);
		temp_volt=temp_volt/10;
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	for (unsigned char j=0;j<=3;j++)
	{
		//---------------------------------------------------------------------------------------
		send_i2c_lcd_symbol(det_string[3-j]);
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------	
};
//***************************************************************************************
//***************************************************************************************
//***************************************************************************************
